name: Docker Image CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:

  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: Run unit tests
      run: |
        cd core-api_app
        go test ./...

build:
  runs-on: ubuntu-latest
  steps:
    - uses: actions/checkout@v4
    
    - name: Clean up existing Docker containers
      run: |
        docker compose -f 'docker-compose.yml' down --remove-orphans
    
    - name: Build and start containers
      run: |
        docker compose -f 'docker-compose.yml' up --force-recreate --build -d
