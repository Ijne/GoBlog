name: CI/CD Pipeline

on:
  push:
    branches: [ "master" ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: Run unit tests
      run: |
        cd core-api_app
        go test ./...
        cd ../notifications_app
        go test ./...

  deploy:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Docker images
      run: |
        docker build -t core-api:latest ./core-api_app
        docker build -t notifications:latest ./notifications_app
        
    - name: Initialize Docker Swarm
      run: |
        docker swarm init --advertise-addr 127.0.0.1
        
    - name: Create overlay network
      run: |
        docker network create -d overlay --attachable app-network || true
        
    - name: Deploy to Swarm
      run: |
        docker stack deploy -c docker-stack.yml my-app
        
    - name: Verify deployment
      run: |
        echo "Waiting for services to start..."
        sleep 30
        docker service ls
        echo "=== Service status ==="
        docker stack ps my-app
        
    - name: Cleanup Swarm
      if: always()
      run: |
        docker stack rm my-app || true
        sleep 10
        docker swarm leave --force || true